# 08-15 笔记

## 1. 差分信号
- **原理**：CAN 总线通过两根线 **CAN_H** 和 **CAN_L** 的电位差来传输信息。  
  - **显性电平 (Dominant, 逻辑 0)**：CAN_H 与 CAN_L 电压差约 2.5V。  
  - **隐性电平 (Recessive, 逻辑 1)**：CAN_H 与 CAN_L 电压差约 0V。  
- **优先级规则**：显性电平优先于隐性电平，只要总线上存在一个显性电平，整个总线电平即为显性。
- **终端电阻**：总线两端必须有 **120Ω** 匹配电阻，减少信号反射。
- **优点**：
  - 抗干扰强（差分信号在共模干扰下抵消）
  - 长距离传输能力强

---

## 2. 仲裁
- **目的**：决定多个节点同时发送数据时，谁拥有总线的发送权。
- **仲裁规则**：
  1. **总线空闲** → 最先开始发送的节点获得发送权。
  2. **同时发送** → 从仲裁段第一位开始比对，显性优先，输出隐性的一方立即停止发送。
  3. **同 ID 情况**：
     - 数据帧 vs 远程帧 → 数据帧（RTR 为显性）优先。
     - 标准帧 vs 扩展帧 → 标准帧优先（同 ID 时）。

---

## 3. 仲裁段
- **作用**：在发送数据前进行总线访问控制和消息优先级判断。
- **格式**：
  - **标准帧**：11 位 ID（ID10 ~ ID0）。
  - **扩展帧**：29 位 ID（基本 ID + 扩展 ID）。
- **关键位**：
  - **ID**：决定优先级（数值越小优先级越高）。
  - **RTR**：数据帧(显性) / 远程帧(隐性) 标识。
  - **IDE**：区分标准帧 / 扩展帧。
  - **SRR**：在扩展帧中代替 RTR（隐性位）。
- **限制**：禁止高 7 位都为隐性（禁止基本 ID = 1111111XXXX）。

---

## 4. 过滤器
- **目的**：减少 MCU 处理无关数据的开销，只接收关心的报文。
- **STM32F4 特性**：
  - 最多 **28 个过滤器组**。
  - 每组由 **两个 32 位寄存器** 组成（CAN_FxR1、CAN_FxR2）。
- **位宽配置**：
  - **1 个 32 位过滤器**：可匹配完整 STDID + EXTID + IDE + RTR。
  - **2 个 16 位过滤器**：每个过滤器匹配部分 ID 位。
- **模式**：
  1. **屏蔽位模式**（Mask Mode）：  
     - 使用屏蔽寄存器指定哪些位必须匹配，哪些位可忽略（“1”=必须匹配，“0”=忽略）。
  2. **标识符列表模式**（List Mode）：  
     - 屏蔽寄存器作为标识符寄存器，必须完全匹配才接收。
- **作用**：通过 ID、IDE、RTR 等字段过滤，提高处理效率。
